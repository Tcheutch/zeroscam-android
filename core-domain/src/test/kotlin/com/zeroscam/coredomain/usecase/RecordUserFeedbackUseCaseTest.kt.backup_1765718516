package com.zeroscam.coredomain.usecase

import com.zeroscam.coredomain.enums.DetectionChannel
import com.zeroscam.coredomain.enums.FeedbackLabel
import com.zeroscam.coredomain.model.DetectionFeedback
import com.zeroscam.coredomain.ports.UserFeedbackRepository
import com.zeroscam.coredomain.value.UserId
import java.time.Instant
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Assert.assertNull
import org.junit.Test

class RecordUserFeedbackUseCaseTest {

    @Test
    fun `records feedback with proper epoch and sanitization`() {
        val repo = InMemoryUserFeedbackRepository()
        val useCase = RecordUserFeedbackUseCase(repo)

        val createdAt = Instant.parse("2024-01-10T12:34:56Z")
        val longComment =
            "  Très bon travail de détection, mais j'ai quand même un doute sur un détail…  " +
                "X".repeat(5_000)

        val feedback =
            useCase(
                detectionId = "det-123",
                userId = UserId("user-abc"),
                channel = DetectionChannel.MESSAGE,
                isScam = true,
                label = FeedbackLabel.TRUE_POSITIVE,
                comment = longComment,
                createdAt = createdAt,
            )

        val saved = repo.lastSavedFeedback
        assertNotNull(saved)

        saved!!
        assertEquals("det-123", saved.detectionId)
        assertEquals(UserId("user-abc"), saved.userId)
        assertEquals(DetectionChannel.MESSAGE, saved.channel)
        assertEquals(true, saved.isScam)
        assertEquals(FeedbackLabel.TRUE_POSITIVE, saved.label)

        // Commentaire nettoyé (non null, tronqué, sans être vide)
        assertNotNull(saved.comment)
        saved.comment!!
        // Pas plus long que la limite
        assert(saved.comment.length <= 1_000)

        // Horodatage et epochSeconds cohérents
        assertEquals(createdAt, saved.createdAt)
        assertEquals(createdAt.epochSecond, saved.createdAtEpochSeconds)

        // L'instance retournée par le use case = celle persistée
        assertEquals(saved, feedback)
    }

    @Test
    fun `records feedback with null comment when blank`() {
        val repo = InMemoryUserFeedbackRepository()
        val useCase = RecordUserFeedbackUseCase(repo)

        val feedback =
            useCase(
                detectionId = "det-456",
                userId = UserId("user-xyz"),
                channel = DetectionChannel.CALL,
                isScam = false,
                label = FeedbackLabel.FALSE_POSITIVE,
                comment = "   ", // blanc → doit devenir null
            )

        val saved = repo.lastSavedFeedback
        assertNotNull(saved)

        saved!!
        assertEquals("det-456", saved.detectionId)
        assertEquals(UserId("user-xyz"), saved.userId)
        assertEquals(DetectionChannel.CALL, saved.channel)
        assertEquals(false, saved.isScam)
        assertEquals(FeedbackLabel.FALSE_POSITIVE, saved.label)

        // Commentaire blanc → null
        assertNull(saved.comment)

        // createdAt auto-généré mais cohérent avec epochSeconds
        assertEquals(saved.createdAt.epochSecond, saved.createdAtEpochSeconds)

        // L'instance retournée par le use case = celle persistée
        assertEquals(saved, feedback)
    }

    // ---------------------------------------------------------------------
    // Fake repository
    // ---------------------------------------------------------------------

    private class InMemoryUserFeedbackRepository : UserFeedbackRepository {

        var lastSavedFeedback: DetectionFeedback? = null
            private set

        override fun saveFeedback(feedback: DetectionFeedback) {
            lastSavedFeedback = feedback
        }
    }
}
